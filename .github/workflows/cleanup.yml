name: 'Cleanup Environment'
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to clean up'
        required: true
        type: choice
        options: [dev, test, prod]
      confirm:
        description: 'Type "DESTROY" to confirm'
        required: true
jobs:
  cleanup:
    name: 'Cleanup Environment'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DESTROY'
    environment: ${{ github.event.inputs.environment }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    - name: Terraform Destroy
      working-directory: terraform/environments/${{ github.event.inputs.environment }}
      run: |
        terraform init
        terraform destroy -auto-approve -var="openweather_api_key=${{ secrets.OPENWEATHER_API_KEY }}"
    - name: Cleanup Kubernetes
      run: |
        az aks get-credentials --resource-group cst8918-final-project-group-5-${{ github.event.inputs.environment }} --name ${{ github.event.inputs.environment }}-weather-aks --overwrite-existing 2>/dev/null || true
        kubectl delete namespace weather-app-${{ github.event.inputs.environment }} --ignore-not-found=true
        echo "í·‘ï¸ Environment ${{ github.event.inputs.environment }} destroyed"
